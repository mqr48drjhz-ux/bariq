{% extends "admin/layout.html" %}

{% block title %}Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª{% endblock %}

{% block page_content %}
<div id="reports-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let revenueChart = null;
    let transactionChart = null;
    let customerChart = null;
    let merchantChart = null;
    let currentReportType = 'financial';
    let currentFilters = {};

    async function loadReports(reportType = 'financial', filters = {}) {
        const container = document.getElementById('reports-content');
        currentReportType = reportType;
        currentFilters = filters;

        // Default date range: last 30 days
        if (!filters.from_date) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            filters.from_date = thirtyDaysAgo.toISOString().split('T')[0];
            filters.to_date = today.toISOString().split('T')[0];
        }

        container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h1>
                    <p style="color: var(--gray-500);">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>
                <button onclick="exportReport()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>

            <!-- Report Type Tabs -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="loadReports('financial', currentFilters)" class="btn ${reportType === 'financial' ? 'btn-primary' : 'btn-secondary'}">ğŸ’° Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
                    <button onclick="loadReports('transactions', currentFilters)" class="btn ${reportType === 'transactions' ? 'btn-primary' : 'btn-secondary'}">ğŸ“‹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</button>
                    <button onclick="loadReports('customers', currentFilters)" class="btn ${reportType === 'customers' ? 'btn-primary' : 'btn-secondary'}">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                    <button onclick="loadReports('merchants', currentFilters)" class="btn ${reportType === 'merchants' ? 'btn-primary' : 'btn-secondary'}">ğŸª Ø§Ù„ØªØ¬Ø§Ø±</button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                    <div style="min-width: 150px;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="fromDate" class="form-control" value="${filters.from_date || ''}">
                    </div>
                    <div style="min-width: 150px;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="toDate" class="form-control" value="${filters.to_date || ''}">
                    </div>
                    <button onclick="applyDateFilter()" class="btn btn-primary">ØªØ·Ø¨ÙŠÙ‚</button>
                    <button onclick="setQuickRange('week')" class="btn btn-secondary">Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</button>
                    <button onclick="setQuickRange('month')" class="btn btn-secondary">Ø¢Ø®Ø± Ø´Ù‡Ø±</button>
                    <button onclick="setQuickRange('quarter')" class="btn btn-secondary">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</button>
                </div>
            </div>

            <div id="report-content">
                <div class="loading-container"><div class="spinner"></div></div>
            </div>
        `;

        // Load specific report
        const reportContainer = document.getElementById('report-content');
        try {
            switch (reportType) {
                case 'financial': await loadFinancialReport(reportContainer, filters); break;
                case 'transactions': await loadTransactionsReport(reportContainer, filters); break;
                case 'customers': await loadCustomersReport(reportContainer, filters); break;
                case 'merchants': await loadMerchantsReport(reportContainer, filters); break;
            }
        } catch (error) {
            showError(reportContainer, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        }
    }

    async function loadFinancialReport(container, filters) {
        const result = await API.admin.getFinancialReport(filters);
        const data = result.data?.data || {};

        container.innerHTML = `
            <!-- KPI Cards -->
            <div class="grid-4" style="margin-bottom: 2rem;">
                <div class="stat-card stat-card-teal">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª</div>
                    <div class="stat-value">${formatCurrency(data.total_revenue || 0)}</div>
                </div>
                <div class="stat-card stat-card-emerald">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-label">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</div>
                    <div class="stat-value">${formatCurrency(data.total_commission || 0)}</div>
                </div>
                <div class="stat-card stat-card-amber">
                    <div class="stat-icon">â³</div>
                    <div class="stat-label">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
                    <div class="stat-value">${formatCurrency(data.outstanding_debt || 0)}</div>
                </div>
                <div class="stat-card stat-card-sky">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</div>
                    <div class="stat-value">${(data.collection_rate || 0).toFixed(1)}%</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
                    <div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="card">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</th>
                                <th>Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª</th>
                                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</th>
                                <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.daily_breakdown || []).map(d => `
                                <tr>
                                    <td>${formatDate(d.date)}</td>
                                    <td>${d.transactions_count || 0}</td>
                                    <td>${formatCurrency(d.revenue)}</td>
                                    <td>${formatCurrency(d.payments)}</td>
                                    <td>${formatCurrency(d.commission)}</td>
                                </tr>
                            `).join('')}
                            ${(data.daily_breakdown || []).length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // Initialize revenue chart
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx && data.daily_breakdown) {
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: data.daily_breakdown.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª',
                        data: data.daily_breakdown.map(d => d.revenue || 0),
                        borderColor: 'rgba(20, 184, 166, 1)',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // Initialize payment methods chart
        const paymentCtx = document.getElementById('paymentMethodsChart');
        if (paymentCtx && data.payment_methods) {
            const methodLabels = { 'creditcard': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†', 'mada': 'Ù…Ø¯Ù‰', 'applepay': 'Apple Pay', 'stcpay': 'STC Pay', 'cash': 'Ù†Ù‚Ø¯ÙŠ' };
            new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.payment_methods).map(k => methodLabels[k] || k),
                    datasets: [{
                        data: Object.values(data.payment_methods),
                        backgroundColor: ['rgba(20, 184, 166, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(99, 102, 241, 0.8)', 'rgba(236, 72, 153, 0.8)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', rtl: true } } }
            });
        }
    }

    async function loadTransactionsReport(container, filters) {
        const result = await API.admin.getOverviewReport({ ...filters, report_type: 'transactions' });
        const data = result.data?.data || {};

        container.innerHTML = `
            <!-- KPI Cards -->
            <div class="grid-4" style="margin-bottom: 2rem;">
                <div class="stat-card stat-card-teal">
                    <div class="stat-icon">ğŸ“‹</div>
                    <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                    <div class="stat-value">${data.total_transactions || 0}</div>
                </div>
                <div class="stat-card stat-card-emerald">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-label">Ù…ÙƒØªÙ…Ù„Ø©</div>
                    <div class="stat-value">${data.paid_transactions || 0}</div>
                </div>
                <div class="stat-card stat-card-amber">
                    <div class="stat-icon">â³</div>
                    <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                    <div class="stat-value">${data.pending_transactions || 0}</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--rose-50), var(--rose-100)); border-color: var(--rose-200);">
                    <div class="stat-icon">ğŸš¨</div>
                    <div class="stat-label" style="color: var(--rose-700);">Ù…ØªØ£Ø®Ø±Ø©</div>
                    <div class="stat-value" style="color: var(--rose-700);">${data.overdue_transactions || 0}</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="chart-container"><canvas id="transactionChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h3>
                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                </div>
            </div>

            <!-- Summary Table -->
            <div class="card">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ù…Ù„Ø®Øµ Ø§Ù„ÙØªØ±Ø©</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(data.avg_transaction_value || 0)}</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(data.max_transaction || 0)}</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--rose-600);">${formatCurrency(data.overdue_amount || 0)}</div>
                    </div>
                </div>
            </div>
        `;

        // Initialize transaction chart
        const ctx = document.getElementById('transactionChart');
        if (ctx && data.daily_transactions) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.daily_transactions.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                        data: data.daily_transactions.map(d => d.count || 0),
                        backgroundColor: 'rgba(20, 184, 166, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // Status distribution chart
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Ù…ÙƒØªÙ…Ù„Ø©', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', 'Ù…ØªØ£Ø®Ø±Ø©', 'Ù…Ù„ØºÙŠØ©'],
                    datasets: [{
                        data: [data.paid_transactions || 0, data.pending_transactions || 0, data.overdue_transactions || 0, data.cancelled_transactions || 0],
                        backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(156, 163, 175, 0.8)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', rtl: true } } }
            });
        }
    }

    async function loadCustomersReport(container, filters) {
        const result = await API.admin.getOverviewReport({ ...filters, report_type: 'customers' });
        const data = result.data?.data || {};

        container.innerHTML = `
            <!-- KPI Cards -->
            <div class="grid-4" style="margin-bottom: 2rem;">
                <div class="stat-card stat-card-teal">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                    <div class="stat-value">${data.total_customers || 0}</div>
                </div>
                <div class="stat-card stat-card-emerald">
                    <div class="stat-icon">ğŸ†•</div>
                    <div class="stat-label">Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯</div>
                    <div class="stat-value">${data.new_customers || 0}</div>
                </div>
                <div class="stat-card stat-card-amber">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†</div>
                    <div class="stat-value">${(data.credit_utilization || 0).toFixed(1)}%</div>
                </div>
                <div class="stat-card stat-card-sky">
                    <div class="stat-icon">â­</div>
                    <div class="stat-label">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
                    <div class="stat-value">${data.active_customers || 0}</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ù†Ù…Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div class="chart-container"><canvas id="customerGrowthChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div class="chart-container"><canvas id="customerStatusChart"></canvas></div>
                </div>
            </div>

            <!-- Top Customers Table -->
            <div class="card">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø¨Ø±ÙŠÙ‚</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.top_customers || []).map(c => `
                                <tr>
                                    <td style="font-family: monospace;">${c.bariq_id || '-'}</td>
                                    <td>${c.full_name_ar || '-'}</td>
                                    <td>${c.transactions_count || 0}</td>
                                    <td>${formatCurrency(c.total_amount)}</td>
                                    <td><span class="badge ${c.payment_rate >= 80 ? 'badge-success' : c.payment_rate >= 50 ? 'badge-warning' : 'badge-danger'}">${(c.payment_rate || 0).toFixed(0)}%</span></td>
                                </tr>
                            `).join('')}
                            ${(data.top_customers || []).length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // Customer growth chart
        const growthCtx = document.getElementById('customerGrowthChart');
        if (growthCtx && data.customer_growth) {
            new Chart(growthCtx, {
                type: 'line',
                data: {
                    labels: data.customer_growth.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯',
                        data: data.customer_growth.map(d => d.count || 0),
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // Customer status chart
        const statusCtx = document.getElementById('customerStatusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø´Ø·', 'Ù…Ø¹Ù„Ù‚', 'Ù…ÙˆÙ‚ÙˆÙ'],
                    datasets: [{
                        data: [data.active_customers || 0, data.pending_customers || 0, data.suspended_customers || 0],
                        backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', rtl: true } } }
            });
        }
    }

    async function loadMerchantsReport(container, filters) {
        const result = await API.admin.getOverviewReport({ ...filters, report_type: 'merchants' });
        const data = result.data?.data || {};

        container.innerHTML = `
            <!-- KPI Cards -->
            <div class="grid-4" style="margin-bottom: 2rem;">
                <div class="stat-card stat-card-teal">
                    <div class="stat-icon">ğŸª</div>
                    <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ø§Ø±</div>
                    <div class="stat-value">${data.total_merchants || 0}</div>
                </div>
                <div class="stat-card stat-card-emerald">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-label">ØªØ¬Ø§Ø± Ù†Ø´Ø·ÙŠÙ†</div>
                    <div class="stat-value">${data.active_merchants || 0}</div>
                </div>
                <div class="stat-card stat-card-amber">
                    <div class="stat-icon">â³</div>
                    <div class="stat-label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div>
                    <div class="stat-value">${data.pending_merchants || 0}</div>
                </div>
                <div class="stat-card stat-card-sky">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙˆØ¹</div>
                    <div class="stat-value">${data.total_branches || 0}</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid-2" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø¬Ø±</h3>
                    <div class="chart-container"><canvas id="merchantTransactionsChart"></canvas></div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">ØªÙˆØ²ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h3>
                    <div class="chart-container"><canvas id="businessTypeChart"></canvas></div>
                </div>
            </div>

            <!-- Top Merchants Table -->
            <div class="card">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø£ÙØ¶Ù„ Ø§Ù„ØªØ¬Ø§Ø±</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</th>
                                <th>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.top_merchants || []).map(m => `
                                <tr>
                                    <td>${m.name_ar || '-'}</td>
                                    <td>${m.business_type || '-'}</td>
                                    <td>${m.transactions_count || 0}</td>
                                    <td>${formatCurrency(m.total_sales)}</td>
                                    <td>${formatCurrency(m.total_commission)}</td>
                                </tr>
                            `).join('')}
                            ${(data.top_merchants || []).length === 0 ? '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // Merchant transactions chart
        const transCtx = document.getElementById('merchantTransactionsChart');
        if (transCtx && data.top_merchants) {
            new Chart(transCtx, {
                type: 'bar',
                data: {
                    labels: data.top_merchants.slice(0, 5).map(m => m.name_ar || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                        data: data.top_merchants.slice(0, 5).map(m => m.transactions_count || 0),
                        backgroundColor: 'rgba(20, 184, 166, 0.8)',
                        borderRadius: 4
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // Business type chart
        const typeCtx = document.getElementById('businessTypeChart');
        if (typeCtx && data.business_types) {
            new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data.business_types),
                    datasets: [{
                        data: Object.values(data.business_types),
                        backgroundColor: ['rgba(20, 184, 166, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(99, 102, 241, 0.8)', 'rgba(236, 72, 153, 0.8)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', rtl: true } } }
            });
        }
    }

    function applyDateFilter() {
        const filters = {
            from_date: document.getElementById('fromDate')?.value || '',
            to_date: document.getElementById('toDate')?.value || ''
        };
        loadReports(currentReportType, filters);
    }

    function setQuickRange(range) {
        const today = new Date();
        let fromDate = new Date(today);

        switch (range) {
            case 'week': fromDate.setDate(today.getDate() - 7); break;
            case 'month': fromDate.setMonth(today.getMonth() - 1); break;
            case 'quarter': fromDate.setMonth(today.getMonth() - 3); break;
        }

        loadReports(currentReportType, {
            from_date: fromDate.toISOString().split('T')[0],
            to_date: today.toISOString().split('T')[0]
        });
    }

    function exportReport() {
        alert('Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±...');
        // Export would depend on current report type and data
    }

    document.addEventListener('DOMContentLoaded', () => loadReports());
</script>

<style>
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
.chart-container { position: relative; height: 250px; width: 100%; }
</style>
{% endblock %}
