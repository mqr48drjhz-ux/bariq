{% extends "customer/layout.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¨Ø±ÙŠÙ‚ Ø§Ù„ÙŠØ³Ø±{% endblock %}

{% block page_content %}
<div id="dashboard-content">
  <div class="loading-container">
    <div class="spinner"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
  async function loadDashboard() {
    const container = document.getElementById('dashboard-content');
    const user = TokenManager.getUser();

    try {
      // Load data in parallel
      const [creditRes, transactionsRes, debtRes] = await Promise.all([
        API.customer.getCredit(),
        API.customer.getTransactions({ per_page: 5 }),
        API.customer.getDebt(),
      ]);

      const credit = creditRes.data?.data || {};
      const transactions = transactionsRes.data?.data?.transactions || [];
      const debt = debtRes.data?.data || {};
      const pendingTransactions = transactions.filter(t => t.status === 'pending');

      container.innerHTML = `
        <!-- Welcome Banner -->
        <div class="welcome-banner">
          <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user?.full_name_ar || 'Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²'}</h1>
          <p>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ ÙˆÙ…Ø¯ÙÙˆØ¹Ø§ØªÙƒ</p>
        </div>
        
        <!-- Credit Cards -->
        <div class="grid grid-3 mb-6">
          <div class="stat-card green">
            <div class="stat-card-header">
              <span>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
              <span style="font-size: 2rem;">ğŸ’³</span>
            </div>
            <div class="stat-card-value">${formatNumber(credit.available_credit || 0)}</div>
            <div class="stat-card-label">Ù†Ù‚Ø·Ø© (1 Ù†Ù‚Ø·Ø© = 1 Ø±ÙŠØ§Ù„)</div>
          </div>
          
          <div class="stat-card gold">
            <div class="stat-card-header">
              <span>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</span>
              <span style="font-size: 2rem;">ğŸ“Š</span>
            </div>
            <div class="stat-card-value">${formatNumber(credit.used_credit || 0)}</div>
            <div class="stat-card-label">Ù†Ù‚Ø·Ø©</div>
          </div>
          
          <div class="stat-card dark">
            <div class="stat-card-header">
              <span>Ø­Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</span>
              <span style="font-size: 2rem;">ğŸ¯</span>
            </div>
            <div class="stat-card-value">${formatNumber(credit.credit_limit || 0)}</div>
            <div class="stat-card-label">Ù†Ù‚Ø·Ø©</div>
          </div>
        </div>
        
        <!-- Bariq ID Card -->
        <div class="bariq-id-card mb-6">
          <div>
            <p class="text-muted text-sm">Ø±Ù‚Ù… Ø¨Ø±ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            <p class="bariq-id-value">${user?.bariq_id || '------'}</p>
            <p class="text-muted text-sm mt-2">Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¬Ø±</p>
          </div>
          <div style="font-size: 3rem;">ğŸ†”</div>
        </div>
        
        ${pendingTransactions.length > 0 ? `
        <!-- Pending Transactions Alert -->
        <div class="pending-alert">
          <div class="pending-alert-header">
            <span style="font-size: 2rem;">âš ï¸</span>
            <div>
              <div class="pending-alert-title">Ù…Ø¹Ø§Ù…Ù„Ø§Øª ØªØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯Ùƒ</div>
              <div class="pending-alert-subtitle">Ù„Ø¯ÙŠÙƒ ${pendingTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div>
            </div>
          </div>
          ${pendingTransactions.map(txn => `
            <div class="pending-item">
              <div>
                <p class="font-bold">${txn.merchant?.name_ar || 'Ù…ØªØ¬Ø±'}</p>
                <p class="text-muted text-sm">${txn.branch?.name_ar || ''} - ${formatDate(txn.transaction_date)}</p>
                <p class="text-primary font-bold mt-2">${formatNumber(txn.total_amount)} Ù†Ù‚Ø·Ø©</p>
              </div>
              <button class="btn btn-primary" onclick="confirmTransaction('${txn.id}', this)">ØªØ£ÙƒÙŠØ¯ âœ“</button>
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        ${debt.total_debt > 0 ? `
        <!-- Debt Alert -->
        <div class="card mb-6" style="background: ${debt.overdue_amount > 0 ? '#fef2f2' : '#fffbeb'}; border: 1px solid ${debt.overdue_amount > 0 ? '#fecaca' : '#fde68a'};">
          <div class="flex items-center justify-between">
            <div>
              <h3 style="color: ${debt.overdue_amount > 0 ? '#991b1b' : '#92400e'}; font-weight: 700;">
                ${debt.overdue_amount > 0 ? 'Ù„Ø¯ÙŠÙƒ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ØªØ£Ø®Ø±Ø©!' : 'Ù„Ø¯ÙŠÙƒ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø§Ø¯Ù…Ø©'}
              </h3>
              <p style="color: ${debt.overdue_amount > 0 ? '#b91c1c' : '#a16207'}; font-size: 0.875rem;">
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª: ${formatNumber(debt.total_debt)} Ù†Ù‚Ø·Ø©
                ${debt.overdue_amount > 0 ? ` (Ù…ØªØ£Ø®Ø±: ${formatNumber(debt.overdue_amount)} Ù†Ù‚Ø·Ø©)` : ''}
              </p>
            </div>
            <a href="/customer/payments" class="btn ${debt.overdue_amount > 0 ? 'btn-danger' : ''}" style="${!debt.overdue_amount > 0 ? 'background: #d97706; color: white;' : ''}">Ø³Ø¯Ø¯ Ø§Ù„Ø¢Ù†</a>
          </div>
        </div>
        ` : ''}
        
        <!-- Quick Actions -->
        <div class="quick-actions mb-6">
          <a href="/customer/transactions" class="quick-action teal">
            <span class="icon">ğŸ“‹</span>
            <span class="font-medium">Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙŠ</span>
          </a>
          <a href="/customer/payments" class="quick-action emerald">
            <span class="icon">ğŸ’°</span>
            <span class="font-medium">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span>
          </a>
          <a href="/customer/credit" class="quick-action amber">
            <span class="icon">ğŸ“ˆ</span>
            <span class="font-medium">Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯</span>
          </a>
          <a href="/customer/profile" class="quick-action sky">
            <span class="icon">ğŸ‘¤</span>
            <span class="font-medium">Ø­Ø³Ø§Ø¨ÙŠ</span>
          </a>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card">
          <div class="card-header">
            <h2 style="font-size: 1.25rem; margin: 0;">Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
            <a href="/customer/transactions" class="text-primary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
          </div>
          
          ${transactions.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ù„Ù…ØªØ¬Ø±</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  </tr>
                </thead>
                <tbody>
                  ${transactions.map(txn => `
                    <tr>
                      <td>${txn.merchant?.name_ar || 'Ù…ØªØ¬Ø±'}</td>
                      <td>${formatDate(txn.transaction_date)}</td>
                      <td class="font-bold">${formatNumber(txn.total_amount)} Ù†Ù‚Ø·Ø©</td>
                      <td><span class="badge ${getStatusBadgeClass(txn.status)}">${getStatusLabel(txn.status)}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : `
            <div class="text-center p-6 text-muted">
              <span style="font-size: 3rem;">ğŸ“­</span>
              <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
            </div>
          `}
        </div>
      `;

    } catch (error) {
      console.error('Error loading dashboard:', error);
      showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  async function confirmTransaction(id, button) {
    button.disabled = true;
    button.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯...';

    try {
      const result = await API.customer.confirmTransaction(id);
      if (result.success && result.data.success) {
        // Reload dashboard
        loadDashboard();
      } else {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
        button.disabled = false;
        button.textContent = 'ØªØ£ÙƒÙŠØ¯ âœ“';
      }
    } catch (error) {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
      button.disabled = false;
      button.textContent = 'ØªØ£ÙƒÙŠØ¯ âœ“';
    }
  }

  // Load dashboard on page load
  document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}