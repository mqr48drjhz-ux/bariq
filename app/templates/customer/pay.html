{% extends "customer/layout.html" %}

{% block title %}Ø§Ù„Ø¯ÙØ¹ - Ø¨Ø±ÙŠÙ‚ Ø§Ù„ÙŠØ³Ø±{% endblock %}

{% block page_content %}
<div class="card mb-6">
  <div class="card-header">
    <h2 style="font-size: 1.5rem; margin: 0;">ğŸ’³ Ø¯ÙØ¹ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</h2>
  </div>

  <div id="payment-content">
    <div class="loading-container">
      <div class="spinner"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
  let selectedTransaction = null;
  let debtData = null;

  async function loadPaymentPage() {
    const container = document.getElementById('payment-content');
    const urlParams = new URLSearchParams(window.location.search);
    const txnId = urlParams.get('txn');

    try {
      // Load debt summary first
      const debtResult = await API.customer.getDebt();
      console.log('Debt result:', debtResult);

      debtData = debtResult.data?.data;

      // If specific transaction requested, load it
      if (txnId) {
        const token = TokenManager.getAccessToken();
        const txnResponse = await fetch(`/api/v1/customers/me/transactions/${txnId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const txnResult = await txnResponse.json();
        console.log('Transaction result:', txnResult);
        if (txnResult.data?.transaction) {
          selectedTransaction = txnResult.data.transaction;
        }
      }

      renderPaymentPage(container);

    } catch (error) {
      console.error('Error loading payment page:', error);
      showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  function renderPaymentPage(container) {
    const totalDebt = debtData?.total_debt || 0;
    const overdueDebt = debtData?.overdue_amount || 0;
    const transactions = debtData?.transactions || [];

    container.innerHTML = `
      <!-- Debt Summary -->
      <div class="debt-summary mb-6">
        <div class="grid grid-2" style="gap: var(--space-4);">
          <div class="debt-card total">
            <span class="debt-icon">ğŸ’°</span>
            <div>
              <p class="debt-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚</p>
              <p class="debt-value">${formatNumber(totalDebt)} Ù†Ù‚Ø·Ø©</p>
            </div>
          </div>
          <div class="debt-card overdue">
            <span class="debt-icon">âš ï¸</span>
            <div>
              <p class="debt-label">Ø§Ù„Ù…ØªØ£Ø®Ø±</p>
              <p class="debt-value">${formatNumber(overdueDebt)} Ù†Ù‚Ø·Ø©</p>
            </div>
          </div>
        </div>
      </div>
      
      ${selectedTransaction ? `
        <!-- Selected Transaction -->
        <div id="selected-txn" class="card mb-6" style="background: var(--teal-50); border-color: var(--teal-200);">
          <div class="flex items-center justify-between mb-4">
            <h3 style="margin: 0;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
            <button onclick="clearSelection()" class="btn btn-secondary btn-sm">âœ• Ø¥Ù„ØºØ§Ø¡</button>
          </div>
          <div class="grid grid-3">
            <div>
              <p class="text-sm text-muted">Ø§Ù„Ù…ØªØ¬Ø±</p>
              <p class="font-bold">${selectedTransaction.merchant?.name_ar || '-'}</p>
            </div>
            <div>
              <p class="text-sm text-muted">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</p>
              <p class="font-bold" style="direction: ltr;">${selectedTransaction.reference_number}</p>
            </div>
            <div>
              <p class="text-sm text-muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
              <p class="font-bold text-danger">${formatNumber(selectedTransaction.remaining_amount)} Ù†Ù‚Ø·Ø©</p>
            </div>
          </div>
        </div>
      ` : `
        <!-- Select Transaction -->
        <div class="card mb-6">
          <h3 style="margin: 0 0 var(--space-4) 0;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„Ø¯ÙØ¹</h3>
          
          ${transactions.length > 0 ? `
            <div class="transaction-list">
              ${transactions.map(txn => `
                <div class="transaction-item ${selectedTransaction?.id === txn.id ? 'selected' : ''}" onclick="selectTransaction('${txn.id}', ${txn.remaining_amount})">
                  <div style="flex: 1;">
                    <p class="font-bold">${txn.merchant_name || txn.merchant?.name_ar || 'Ù…ØªØ¬Ø±'}</p>
                    <p class="text-sm text-muted">${txn.reference_number} â€¢ ${formatDate(txn.due_date)}</p>
                  </div>
                  <div style="text-align: left;">
                    <p class="font-bold text-lg ${txn.is_overdue ? 'text-danger' : ''}">${formatNumber(txn.remaining_amount)} Ø±ÙŠØ§Ù„</p>
                    ${txn.is_overdue ? '<span class="badge badge-danger">Ù…ØªØ£Ø®Ø±</span>' : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="text-center p-6 text-muted">
              <span style="font-size: 3rem;">âœ…</span>
              <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª</p>
              <a href="/customer" class="btn btn-primary mt-4">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>
          `}
        </div>
      `}
      
      ${(selectedTransaction || transactions.length > 0) ? `
        <!-- Payment Form -->
        <div class="card">
          <h3 style="margin: 0 0 var(--space-4) 0;">ğŸ’µ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h3>
          
          <form onsubmit="submitPayment(event)">
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input type="number" id="payment-amount" class="form-input" dir="ltr" 
                     placeholder="0" min="1" step="0.01" required
                     value="${selectedTransaction ? selectedTransaction.remaining_amount : ''}"
                     max="${selectedTransaction ? selectedTransaction.remaining_amount : totalDebt}">
              <small class="text-muted">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${formatNumber(selectedTransaction ? selectedTransaction.remaining_amount : totalDebt)} Ù†Ù‚Ø·Ø©</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
              <div class="payment-methods">
                <label class="payment-method selected" onclick="selectPaymentMethod('paytabs')">
                  <input type="radio" name="payment_method" value="paytabs" checked hidden>
                  <span class="method-icon">ğŸ’³</span>
                  <span class="method-name">Ø¨Ø·Ø§Ù‚Ø© / Ù…Ø¯Ù‰</span>
                </label>
                <label class="payment-method" onclick="selectPaymentMethod('bank_transfer')">
                  <input type="radio" name="payment_method" value="bank_transfer" hidden>
                  <span class="method-icon">ğŸ¦</span>
                  <span class="method-name">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</span>
                </label>
                <label class="payment-method" onclick="selectPaymentMethod('stcpay')">
                  <input type="radio" name="payment_method" value="stcpay" hidden>
                  <span class="method-icon">ğŸ“±</span>
                  <span class="method-name">STC Pay</span>
                </label>
                <label class="payment-method" onclick="selectPaymentMethod('applepay')">
                  <input type="radio" name="payment_method" value="applepay" hidden>
                  <span class="method-icon">ğŸ</span>
                  <span class="method-name">Apple Pay</span>
                </label>
              </div>
            </div>
            
            <!-- Bank Transfer Info (hidden by default) -->
            <div id="bank-info" class="card mb-4" style="background: var(--gray-50); display: none;">
              <h4 style="margin: 0 0 var(--space-3) 0;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ</h4>
              <div class="info-row">
                <span class="info-label">Ø§Ù„Ø¨Ù†Ùƒ</span>
                <span class="info-value">Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                <span class="info-value" style="direction: ltr;">123456789012</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†</span>
                <span class="info-value" style="direction: ltr;">SA1234567890123456789012</span>
              </div>
              <p class="text-sm text-muted mt-3">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø°ÙƒØ± Ø±Ù‚Ù… Ø¨Ø±ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙÙŠ ÙˆØµÙ Ø§Ù„ØªØ­ÙˆÙŠÙ„</p>
            </div>

            <!-- PayTabs Info -->
            <div id="paytabs-info" class="card mb-4" style="background: var(--teal-50); border: 1px solid var(--teal-200);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 2rem;">ğŸ”’</span>
                <div>
                  <h4 style="margin: 0;">Ø¯ÙØ¹ Ø¢Ù…Ù† Ø¹Ø¨Ø± PayTabs</h4>
                  <p class="text-sm text-muted" style="margin: 4px 0 0 0;">Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
                </div>
              </div>
            </div>
            
            <div id="payment-error" class="alert alert-error hidden"></div>
            <div id="payment-success" class="alert alert-success hidden"></div>
            
            <button type="submit" id="submit-btn" class="btn btn-primary btn-lg btn-block">
              Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†
            </button>
          </form>
        </div>
      ` : ''}
    `;
  }

  function selectTransaction(txnId, remainingAmount) {
    // Find the transaction in our data
    const txn = debtData?.transactions?.find(t => t.id === txnId);
    if (txn) {
      selectedTransaction = txn;
      // Update UI to show selection
      document.querySelectorAll('.transaction-item').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');

      // Update amount field
      const amountInput = document.getElementById('payment-amount');
      if (amountInput) {
        amountInput.value = remainingAmount || txn.remaining_amount;
        amountInput.max = txn.remaining_amount;
      }

      // Hide error if shown
      const errorEl = document.getElementById('payment-error');
      if (errorEl) errorEl.classList.add('hidden');
    }
  }

  function clearSelection() {
    selectedTransaction = null;
    window.location.href = '/customer/pay';
  }

  function selectPaymentMethod(method) {
    document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
    document.querySelector(`input[value="${method}"]`).parentElement.classList.add('selected');
    document.querySelector(`input[value="${method}"]`).checked = true;

    // Show/hide info sections
    const bankInfo = document.getElementById('bank-info');
    const paytabsInfo = document.getElementById('paytabs-info');

    if (bankInfo) {
      bankInfo.style.display = method === 'bank_transfer' ? 'block' : 'none';
    }
    if (paytabsInfo) {
      paytabsInfo.style.display = ['paytabs', 'stcpay', 'applepay'].includes(method) ? 'block' : 'none';
    }

    // Update button text
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
      if (['paytabs', 'stcpay', 'applepay'].includes(method)) {
        submitBtn.textContent = 'Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†';
      } else {
        submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹';
      }
    }
  }

  async function submitPayment(event) {
    event.preventDefault();

    const amount = parseFloat(document.getElementById('payment-amount').value);
    const method = document.querySelector('input[name="payment_method"]:checked').value;
    const errorEl = document.getElementById('payment-error');
    const successEl = document.getElementById('payment-success');
    const submitBtn = document.getElementById('submit-btn');

    errorEl.classList.add('hidden');
    successEl.classList.add('hidden');

    if (!selectedTransaction) {
      errorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„Ø¯ÙØ¹';
      errorEl.classList.remove('hidden');
      return;
    }

    if (amount <= 0) {
      errorEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­';
      errorEl.classList.remove('hidden');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';

    try {
      // Check if using PayTabs gateway
      if (['paytabs', 'stcpay', 'applepay'].includes(method)) {
        // Initiate PayTabs payment
        const token = TokenManager.getAccessToken();
        const response = await fetch('/api/v1/customers/me/payments/initiate', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            transaction_ids: [selectedTransaction.id],
            amount: amount,
            payment_method: method === 'paytabs' ? 'all' : method
          })
        });

        const result = await response.json();

        if (result.success && result.data?.payment_url) {
          successEl.innerHTML = `
            âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹...<br>
            <small>Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†Ù</small>
          `;
          successEl.classList.remove('hidden');

          // Redirect to PayTabs payment page
          setTimeout(() => {
            window.location.href = result.data.payment_url;
          }, 1500);
        } else {
          errorEl.textContent = result.message || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹';
          errorEl.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†';
        }
      } else {
        // Manual payment (bank transfer, etc.)
        const result = await API.customer.makePayment(selectedTransaction.id, amount, method);

        if (result.success && result.data.success) {
          successEl.innerHTML = `
            âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!<br>
            <small>Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</small>
          `;
          successEl.classList.remove('hidden');

          setTimeout(() => {
            window.location.href = '/customer/transactions';
          }, 2000);
        } else {
          errorEl.textContent = result.data?.message || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹';
          errorEl.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹';
        }
      }
    } catch (error) {
      console.error('Payment error:', error);
      errorEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹';
      errorEl.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = method.includes('paytabs') ? 'Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹';
    }
  }

  document.addEventListener('DOMContentLoaded', loadPaymentPage);
</script>

<style>
  .debt-summary {
    background: linear-gradient(135deg, var(--teal-50), white);
    border-radius: var(--radius-xl);
    padding: var(--space-4);
  }

  .debt-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    border-radius: var(--radius-lg);
    background: white;
  }

  .debt-card.total {
    border-left: 4px solid var(--teal-500);
  }

  .debt-card.overdue {
    border-left: 4px solid var(--red-500);
  }

  .debt-icon {
    font-size: 2rem;
  }

  .debt-label {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin: 0;
  }

  .debt-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
  }

  .transaction-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
  }

  .transaction-item:hover {
    background: var(--teal-50);
    border-color: var(--teal-200);
  }

  .transaction-item.selected {
    background: var(--teal-50);
    border-color: var(--teal-500);
  }

  .payment-methods {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-3);
  }

  .payment-method {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-4);
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
  }

  .payment-method:hover {
    background: var(--teal-50);
  }

  .payment-method.selected {
    background: var(--teal-50);
    border-color: var(--teal-500);
  }

  .method-icon {
    font-size: 1.5rem;
    margin-bottom: var(--space-2);
  }

  .method-name {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--gray-200);
  }

  .info-row:last-of-type {
    border-bottom: none;
  }

  @media (max-width: 768px) {
    .payment-methods {
      grid-template-columns: repeat(2, 1fr);
    }

    .transaction-item {
      flex-direction: column;
      text-align: center;
      gap: var(--space-3);
    }
  }
</style>
{% endblock %}