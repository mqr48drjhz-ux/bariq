{% extends "base.html" %}

{% block navbar %}
<nav class="navbar">
    <div class="container navbar-content">
        <a href="/merchant" class="navbar-brand">
            <div class="navbar-brand-icon">Ø¨</div>
            <div>
                <div>Ø¨Ø±ÙŠÙ‚ Ø§Ù„ÙŠØ³Ø±</div>
                <div id="role-badge" style="font-size: 0.75rem; color: var(--gray-500); font-weight: normal;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</div>
            </div>
        </a>

        <div class="navbar-actions" style="display: flex; align-items: center; gap: 1rem;">
            <div id="user-info" style="text-align: left; font-size: 0.875rem;">
                <div id="user-name" style="font-weight: 600; color: var(--gray-700);"></div>
                <div id="user-role" style="font-size: 0.75rem; color: var(--teal-600);"></div>
            </div>
            <button onclick="logout()" class="btn btn-secondary btn-sm" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
            </button>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <!-- Dynamic navigation will be loaded here -->
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        {% block page_content %}{% endblock %}
    </main>
</div>

<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav" id="mobile-nav">
    <!-- Dynamic mobile nav will be loaded here -->
</nav>
{% endblock %}

{% block extra_js %}
<script>
    // Role names in Arabic
    const roleNamesAr = {
        'owner': 'Ø§Ù„Ù…Ø§Ù„Ùƒ',
        'executive_manager': 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ',
        'region_manager': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
        'branch_manager': 'Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹',
        'cashier': 'ÙƒØ§Ø´ÙŠØ±'
    };

    // Navigation items by role
    const navConfig = {
        // Top level roles see everything
        'owner': [
            { url: '/merchant', icon: 'ðŸ ', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', page: 'dashboard' },
            { url: '/merchant/reports', icon: 'ðŸ“Š', label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', page: 'reports' },
            { url: '/merchant/new-transaction', icon: 'âž•', label: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', page: 'new-transaction' },
            { url: '/merchant/transactions', icon: 'ðŸ“‹', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', page: 'transactions' },
            { url: '/merchant/settlements', icon: 'ðŸ’°', label: 'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª', page: 'settlements' },
            { url: '/merchant/team', icon: 'ðŸ‘¥', label: 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„', page: 'team' },
            { url: '/merchant/regions', icon: 'ðŸ—ºï¸', label: 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', page: 'regions' },
            { url: '/merchant/branches', icon: 'ðŸª', label: 'Ø§Ù„ÙØ±ÙˆØ¹', page: 'branches' },
        ],
        'executive_manager': [
            { url: '/merchant', icon: 'ðŸ ', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', page: 'dashboard' },
            { url: '/merchant/reports', icon: 'ðŸ“Š', label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', page: 'reports' },
            { url: '/merchant/new-transaction', icon: 'âž•', label: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', page: 'new-transaction' },
            { url: '/merchant/transactions', icon: 'ðŸ“‹', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', page: 'transactions' },
            { url: '/merchant/settlements', icon: 'ðŸ’°', label: 'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª', page: 'settlements' },
            { url: '/merchant/team', icon: 'ðŸ‘¥', label: 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„', page: 'team' },
            { url: '/merchant/regions', icon: 'ðŸ—ºï¸', label: 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', page: 'regions' },
            { url: '/merchant/branches', icon: 'ðŸª', label: 'Ø§Ù„ÙØ±ÙˆØ¹', page: 'branches' },
        ],
        'region_manager': [
            { url: '/merchant', icon: 'ðŸ ', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', page: 'dashboard' },
            { url: '/merchant/reports', icon: 'ðŸ“Š', label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', page: 'reports' },
            { url: '/merchant/new-transaction', icon: 'âž•', label: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', page: 'new-transaction' },
            { url: '/merchant/transactions', icon: 'ðŸ“‹', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', page: 'transactions' },
            { url: '/merchant/settlements', icon: 'ðŸ’°', label: 'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª', page: 'settlements' },
            { url: '/merchant/team', icon: 'ðŸ‘¥', label: 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„', page: 'team' },
            { url: '/merchant/branches', icon: 'ðŸª', label: 'Ø§Ù„ÙØ±ÙˆØ¹', page: 'branches' },
        ],
        'branch_manager': [
            { url: '/merchant', icon: 'ðŸ ', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', page: 'dashboard' },
            { url: '/merchant/reports', icon: 'ðŸ“Š', label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', page: 'reports' },
            { url: '/merchant/new-transaction', icon: 'âž•', label: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', page: 'new-transaction' },
            { url: '/merchant/transactions', icon: 'ðŸ“‹', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', page: 'transactions' },
            { url: '/merchant/settlements', icon: 'ðŸ’°', label: 'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª', page: 'settlements' },
            { url: '/merchant/team', icon: 'ðŸ‘¥', label: 'ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„', page: 'team' },
        ],
        'cashier': [
            { url: '/merchant', icon: 'ðŸ ', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', page: 'dashboard' },
            { url: '/merchant/new-transaction', icon: 'âž•', label: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', page: 'new-transaction' },
            { url: '/merchant/transactions', icon: 'ðŸ“‹', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', page: 'transactions' },
        ]
    };

    // Get current page from URL
    function getCurrentPage() {
        const path = window.location.pathname;
        if (path === '/merchant' || path === '/merchant/') return 'dashboard';
        const match = path.match(/\/merchant\/([^\/]+)/);
        return match ? match[1] : 'dashboard';
    }

    // Build navigation for role
    function buildNavigation(role) {
        const items = navConfig[role] || navConfig['cashier'];
        const currentPage = getCurrentPage();

        // Build sidebar
        const sidebarNav = document.getElementById('sidebar-nav');
        if (sidebarNav) {
            sidebarNav.innerHTML = items.map(item => `
                <li>
                    <a href="${item.url}" class="${currentPage === item.page ? 'active' : ''}">
                        <span class="icon">${item.icon}</span>
                        <span>${item.label}</span>
                    </a>
                </li>
            `).join('');
        }

        // Build mobile nav (first 4 items)
        const mobileNav = document.getElementById('mobile-nav');
        if (mobileNav) {
            const mobileItems = items.slice(0, 4);
            mobileNav.innerHTML = mobileItems.map(item => `
                <a href="${item.url}" class="${currentPage === item.page ? 'active' : ''}">
                    <span class="icon">${item.icon}</span>
                    <span>${item.label.split(' ')[0]}</span>
                </a>
            `).join('');
        }
    }

    // Update user info in navbar
    function updateUserInfo(user) {
        const userNameEl = document.getElementById('user-name');
        const userRoleEl = document.getElementById('user-role');
        const roleBadgeEl = document.getElementById('role-badge');

        if (userNameEl && user) {
            userNameEl.textContent = user.full_name || '';
        }
        if (userRoleEl && user) {
            userRoleEl.textContent = roleNamesAr[user.role] || user.role;
        }
        if (roleBadgeEl && user) {
            roleBadgeEl.textContent = roleNamesAr[user.role] || 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±';
        }
    }

    // Check authentication and build navigation
    if (!requireAuth(['merchant'])) {
        // Will redirect to login
    } else {
        const user = TokenManager.getUser();
        if (user) {
            const role = user.role || 'cashier';
            buildNavigation(role);
            updateUserInfo(user);
        }
    }

    // Helper function to check role permissions
    function hasRole(allowedRoles) {
        const user = TokenManager.getUser();
        if (!user) return false;
        return allowedRoles.includes(user.role);
    }

    // Check if user can see all regions/branches
    function canSeeAllRegions() {
        return hasRole(['owner', 'executive_manager']);
    }

    function canSeeAllBranches() {
        return hasRole(['owner', 'executive_manager']);
    }

    function canManageStaff() {
        return hasRole(['owner', 'executive_manager', 'region_manager', 'branch_manager']);
    }

    function isTopLevel() {
        return hasRole(['owner', 'executive_manager']);
    }
</script>
{{ super() }}
{% endblock %}