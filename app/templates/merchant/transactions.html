{% extends "merchant/layout.html" %}

{% block title %}Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª - Ø§Ù„ØªØ§Ø¬Ø±{% endblock %}

{% block page_content %}
<div class="card">
  <div class="card-header">
    <h2 style="font-size: 1.5rem; margin: 0;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
    <a href="/merchant/new-transaction" class="btn btn-primary btn-sm">â• Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
  </div>

  <div id="transactions-content">
    <div class="loading-container">
      <div class="spinner"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
  async function loadTransactions() {
    const container = document.getElementById('transactions-content');

    try {
      const result = await API.merchant.getTransactions({ per_page: 50 });
      console.log('Transactions API result:', result);

      // Safely extract transactions array
      let transactions = [];
      if (result.success && result.data?.data?.transactions && Array.isArray(result.data.data.transactions)) {
        transactions = result.data.data.transactions;
      } else if (result.success && Array.isArray(result.data?.data)) {
        transactions = result.data.data;
      }
      console.log('Transactions extracted:', transactions);

      if (transactions.length === 0) {
        container.innerHTML = `
          <div class="text-center p-6 text-muted">
            <span style="font-size: 3rem;">ğŸ“­</span>
            <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
            <a href="/merchant/new-transaction" class="btn btn-primary mt-4">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody>
              ${transactions.map(txn => `
                <tr>
                  <td style="direction: ltr;">${txn.reference_number || '-'}</td>
                  <td>${txn.customer?.full_name_ar || 'Ø¹Ù…ÙŠÙ„'}</td>
                  <td>${formatDate(txn.transaction_date)}</td>
                  <td class="font-bold">${formatNumber(txn.total_amount)} Ø±ÙŠØ§Ù„</td>
                  <td>${formatNumber(txn.paid_amount || 0)} Ø±ÙŠØ§Ù„</td>
                  <td><span class="badge ${getStatusBadgeClass(txn.status)}">${getStatusLabel(txn.status)}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

    } catch (error) {
      console.error('Error loading transactions:', error);
      showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª');
    }
  }

  document.addEventListener('DOMContentLoaded', loadTransactions);
</script>
{% endblock %}