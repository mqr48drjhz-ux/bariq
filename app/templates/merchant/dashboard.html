{% extends "merchant/layout.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„ØªØ§Ø¬Ø±{% endblock %}

{% block page_content %}
<div id="dashboard-content">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    async function loadDashboard() {
        const container = document.getElementById('dashboard-content');
        const user = TokenManager.getUser();

        try {
            // Load dashboard data
            const [dashboardRes, transactionsRes] = await Promise.all([
                API.merchant.getDashboard(),
                API.merchant.getTransactions({ per_page: 5 }),
            ]);

            const dashboard = dashboardRes.data?.data || {};
            const transactions = transactionsRes.data?.data?.transactions || [];

            container.innerHTML = `
        <!-- Welcome Banner -->
        <div class="welcome-banner">
          <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user?.merchant?.name_ar || 'Ø§Ù„ØªØ§Ø¬Ø±'}</h1>
          <p>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙƒ ÙˆÙ…Ø¨ÙŠØ¹Ø§ØªÙƒ</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-4 mb-6">
          <div class="stat-card teal">
            <div class="stat-card-header">
              <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
              <span style="font-size: 2rem;">ğŸ’°</span>
            </div>
            <div class="stat-card-value">${formatNumber(dashboard.total_sales || 0)}</div>
            <div class="stat-card-label">Ø±ÙŠØ§Ù„</div>
          </div>
          
          <div class="stat-card emerald">
            <div class="stat-card-header">
              <span>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©</span>
              <span style="font-size: 2rem;">âœ…</span>
            </div>
            <div class="stat-card-value">${dashboard.confirmed_transactions || 0}</div>
            <div class="stat-card-label">Ù…Ø¹Ø§Ù…Ù„Ø©</div>
          </div>
          
          <div class="stat-card amber">
            <div class="stat-card-header">
              <span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</span>
              <span style="font-size: 2rem;">â³</span>
            </div>
            <div class="stat-card-value">${dashboard.pending_transactions || 0}</div>
            <div class="stat-card-label">Ù…Ø¹Ø§Ù…Ù„Ø©</div>
          </div>
          
          <div class="stat-card blue">
            <div class="stat-card-header">
              <span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³ÙˆÙŠØ©</span>
              <span style="font-size: 2rem;">ğŸ“Š</span>
            </div>
            <div class="stat-card-value">${formatNumber(dashboard.pending_settlement || 0)}</div>
            <div class="stat-card-label">Ø±ÙŠØ§Ù„</div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="grid grid-3 mb-6">
          <a href="/merchant/new-transaction" class="quick-action teal">
            <span class="icon">â•</span>
            <span class="font-medium">Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
          </a>
          <a href="/merchant/transactions" class="quick-action emerald">
            <span class="icon">ğŸ“‹</span>
            <span class="font-medium">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</span>
          </a>
          <a href="/merchant/settlements" class="quick-action amber">
            <span class="icon">ğŸ’°</span>
            <span class="font-medium">Ø§Ù„ØªØ³ÙˆÙŠØ§Øª</span>
          </a>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card">
          <div class="card-header">
            <h2 style="font-size: 1.25rem; margin: 0;">Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
            <a href="/merchant/transactions" class="text-primary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
          </div>
          
          ${transactions.length > 0 ? `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  </tr>
                </thead>
                <tbody>
                  ${transactions.map(txn => `
                    <tr>
                      <td style="direction: ltr;">${txn.reference_number || '-'}</td>
                      <td>${txn.customer?.full_name_ar || 'Ø¹Ù…ÙŠÙ„'}</td>
                      <td>${formatDate(txn.transaction_date)}</td>
                      <td class="font-bold">${formatNumber(txn.total_amount)} Ø±ÙŠØ§Ù„</td>
                      <td><span class="badge ${getStatusBadgeClass(txn.status)}">${getStatusLabel(txn.status)}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : `
            <div class="text-center p-6 text-muted">
              <span style="font-size: 3rem;">ğŸ“­</span>
              <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
              <a href="/merchant/new-transaction" class="btn btn-primary mt-4">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
            </div>
          `}
        </div>
      `;

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}