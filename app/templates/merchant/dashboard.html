{% extends "merchant/layout.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„ØªØ§Ø¬Ø±{% endblock %}

{% block page_content %}
<div id="dashboard-content">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    async function loadDashboard() {
        const container = document.getElementById('dashboard-content');
        const user = TokenManager.getUser();
        const role = user?.role || 'cashier';

        try {
            // Load dashboard data
            const [dashboardRes, transactionsRes] = await Promise.all([
                API.merchant.getDashboard(),
                API.merchant.getTransactions({ per_page: 5 }),
            ]);

            const dashboard = dashboardRes.data?.data || {};
            const transactions = transactionsRes.data?.data?.transactions || [];

            // Get welcome message based on role
            const welcomeMessages = {
                'owner': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ',
                'executive_manager': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ',
                'region_manager': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                'branch_manager': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹',
                'cashier': 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ'
            };

            const roleDescriptions = {
                'owner': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                'executive_manager': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                'region_manager': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙˆØ¹ Ù…Ù†Ø·Ù‚ØªÙƒ ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                'branch_manager': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙØ±Ø¹Ùƒ ÙˆØ§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª',
                'cashier': 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§'
            };

            // Build quick actions based on role
            let quickActions = '';
            if (role === 'cashier') {
                quickActions = `
                    <a href="/merchant/new-transaction" class="quick-action teal">
                        <span class="icon">â•</span>
                        <span class="font-medium">Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </a>
                    <a href="/merchant/transactions" class="quick-action emerald">
                        <span class="icon">ğŸ“‹</span>
                        <span class="font-medium">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</span>
                    </a>
                `;
            } else if (role === 'branch_manager') {
                quickActions = `
                    <a href="/merchant/new-transaction" class="quick-action teal">
                        <span class="icon">â•</span>
                        <span class="font-medium">Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </a>
                    <a href="/merchant/transactions" class="quick-action emerald">
                        <span class="icon">ğŸ“‹</span>
                        <span class="font-medium">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</span>
                    </a>
                    <a href="/merchant/team" class="quick-action sky">
                        <span class="icon">ğŸ‘¥</span>
                        <span class="font-medium">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</span>
                    </a>
                    <a href="/merchant/reports" class="quick-action amber">
                        <span class="icon">ğŸ“Š</span>
                        <span class="font-medium">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                    </a>
                `;
            } else if (role === 'region_manager') {
                quickActions = `
                    <a href="/merchant/reports" class="quick-action teal">
                        <span class="icon">ğŸ“Š</span>
                        <span class="font-medium">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                    </a>
                    <a href="/merchant/branches" class="quick-action emerald">
                        <span class="icon">ğŸª</span>
                        <span class="font-medium">Ø§Ù„ÙØ±ÙˆØ¹</span>
                    </a>
                    <a href="/merchant/team" class="quick-action sky">
                        <span class="icon">ğŸ‘¥</span>
                        <span class="font-medium">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</span>
                    </a>
                    <a href="/merchant/settlements" class="quick-action amber">
                        <span class="icon">ğŸ’°</span>
                        <span class="font-medium">Ø§Ù„ØªØ³ÙˆÙŠØ§Øª</span>
                    </a>
                `;
            } else {
                // Owner / Executive Manager
                quickActions = `
                    <a href="/merchant/reports" class="quick-action teal">
                        <span class="icon">ğŸ“Š</span>
                        <span class="font-medium">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                    </a>
                    <a href="/merchant/regions" class="quick-action emerald">
                        <span class="icon">ğŸ—ºï¸</span>
                        <span class="font-medium">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>
                    </a>
                    <a href="/merchant/team" class="quick-action sky">
                        <span class="icon">ğŸ‘¥</span>
                        <span class="font-medium">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</span>
                    </a>
                    <a href="/merchant/settlements" class="quick-action amber">
                        <span class="icon">ğŸ’°</span>
                        <span class="font-medium">Ø§Ù„ØªØ³ÙˆÙŠØ§Øª</span>
                    </a>
                `;
            }

            // Build scope info based on role
            let scopeInfo = '';
            if (role === 'region_manager' && user.region_id) {
                scopeInfo = `<div class="scope-badge">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${user.region_name || 'Ù…Ù†Ø·Ù‚ØªÙƒ'}</div>`;
            } else if (role === 'branch_manager' && user.branch_id) {
                scopeInfo = `<div class="scope-badge">Ø§Ù„ÙØ±Ø¹: ${user.branch_name || 'ÙØ±Ø¹Ùƒ'}</div>`;
            }

            container.innerHTML = `
                <!-- Welcome Banner -->
                <div class="welcome-banner">
                    <h1>${welcomeMessages[role] || 'Ù…Ø±Ø­Ø¨Ø§Ù‹'}</h1>
                    <p>${roleDescriptions[role] || ''}</p>
                    ${scopeInfo}
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-4 mb-6">
                    <div class="stat-card teal">
                        <div class="stat-card-header">
                            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                            <span style="font-size: 2rem;">ğŸ’°</span>
                        </div>
                        <div class="stat-card-value">${formatNumber(dashboard.total_sales || 0)}</div>
                        <div class="stat-card-label">Ø±ÙŠØ§Ù„</div>
                    </div>

                    <div class="stat-card emerald">
                        <div class="stat-card-header">
                            <span>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©</span>
                            <span style="font-size: 2rem;">âœ…</span>
                        </div>
                        <div class="stat-card-value">${dashboard.confirmed_transactions || 0}</div>
                        <div class="stat-card-label">Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                    </div>

                    <div class="stat-card amber">
                        <div class="stat-card-header">
                            <span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</span>
                            <span style="font-size: 2rem;">â³</span>
                        </div>
                        <div class="stat-card-value">${dashboard.pending_transactions || 0}</div>
                        <div class="stat-card-label">Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                    </div>

                    <div class="stat-card blue">
                        <div class="stat-card-header">
                            <span>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³ÙˆÙŠØ©</span>
                            <span style="font-size: 2rem;">ğŸ“Š</span>
                        </div>
                        <div class="stat-card-value">${formatNumber(dashboard.pending_settlement || 0)}</div>
                        <div class="stat-card-label">Ø±ÙŠØ§Ù„</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-${role === 'cashier' ? '2' : '4'} mb-6">
                    ${quickActions}
                </div>

                ${canManageStaff() ? `
                <!-- Team Summary for Managers -->
                <div class="grid grid-2 mb-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 style="margin: 0;">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h3>
                            <a href="/merchant/team" class="text-primary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div id="team-summary" class="text-center p-4">
                            <div class="spinner"></div>
                        </div>
                    </div>

                    ${isTopLevel() || role === 'region_manager' ? `
                    <div class="card">
                        <div class="card-header">
                            <h3 style="margin: 0;">${isTopLevel() ? 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„ÙØ±ÙˆØ¹' : 'ÙØ±ÙˆØ¹ Ù…Ù†Ø·Ù‚ØªÙƒ'}</h3>
                            <a href="/merchant/branches" class="text-primary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div id="branches-summary" class="text-center p-4">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    ` : `
                    <div class="card">
                        <div class="card-header">
                            <h3 style="margin: 0;">Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</h3>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between mb-4">
                                <span>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</span>
                                <span class="font-bold">${dashboard.today_transactions || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                                <span class="font-bold">${formatNumber(dashboard.today_sales || 0)} Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                    </div>
                    `}
                </div>
                ` : ''}

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="card-header">
                        <h2 style="font-size: 1.25rem; margin: 0;">Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
                        <a href="/merchant/transactions" class="text-primary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                    </div>

                    ${transactions.length > 0 ? `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        ${role !== 'cashier' && role !== 'branch_manager' ? '<th>Ø§Ù„ÙØ±Ø¹</th>' : ''}
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactions.map(txn => `
                                        <tr>
                                            <td style="direction: ltr;">${txn.reference_number || '-'}</td>
                                            <td>${txn.customer?.full_name_ar || 'Ø¹Ù…ÙŠÙ„'}</td>
                                            ${role !== 'cashier' && role !== 'branch_manager' ? `<td>${txn.branch?.name_ar || '-'}</td>` : ''}
                                            <td>${formatDate(txn.transaction_date)}</td>
                                            <td class="font-bold">${formatNumber(txn.total_amount)} Ø±ÙŠØ§Ù„</td>
                                            <td><span class="badge ${getStatusBadgeClass(txn.status)}">${getStatusLabel(txn.status)}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center p-6 text-muted">
                            <span style="font-size: 3rem;">ğŸ“­</span>
                            <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                            <a href="/merchant/new-transaction" class="btn btn-primary mt-4">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</a>
                        </div>
                    `}
                </div>
            `;

            // Load additional data for managers
            if (canManageStaff()) {
                loadTeamSummary();
                if (isTopLevel() || role === 'region_manager') {
                    loadBranchesSummary();
                }
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    async function loadTeamSummary() {
        const container = document.getElementById('team-summary');
        if (!container) return;

        try {
            const res = await API.merchant.getStaff();
            const staff = res.data?.data?.staff || [];

            // Count by role
            const counts = {
                'executive_manager': 0,
                'region_manager': 0,
                'branch_manager': 0,
                'cashier': 0
            };

            staff.forEach(s => {
                if (counts[s.role] !== undefined) {
                    counts[s.role]++;
                }
            });

            container.innerHTML = `
                <div class="team-stats">
                    ${isTopLevel() ? `
                    <div class="team-stat">
                        <div class="team-stat-value">${counts.executive_manager}</div>
                        <div class="team-stat-label">Ù…Ø¯ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ</div>
                    </div>
                    <div class="team-stat">
                        <div class="team-stat-value">${counts.region_manager}</div>
                        <div class="team-stat-label">Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø©</div>
                    </div>
                    ` : ''}
                    <div class="team-stat">
                        <div class="team-stat-value">${counts.branch_manager}</div>
                        <div class="team-stat-label">Ù…Ø¯ÙŠØ± ÙØ±Ø¹</div>
                    </div>
                    <div class="team-stat">
                        <div class="team-stat-value">${counts.cashier}</div>
                        <div class="team-stat-label">ÙƒØ§Ø´ÙŠØ±</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading team summary:', error);
            container.innerHTML = '<div class="text-muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
        }
    }

    async function loadBranchesSummary() {
        const container = document.getElementById('branches-summary');
        if (!container) return;

        try {
            const [regionsRes, branchesRes] = await Promise.all([
                API.merchant.getRegions ? API.merchant.getRegions() : { data: { data: { regions: [] } } },
                API.merchant.getBranches()
            ]);

            const regions = regionsRes.data?.data?.regions || [];
            const branches = branchesRes.data?.data?.branches || [];

            const activeRegions = regions.filter(r => r.is_active).length;
            const activeBranches = branches.filter(b => b.is_active).length;

            container.innerHTML = `
                <div class="team-stats">
                    ${isTopLevel() ? `
                    <div class="team-stat">
                        <div class="team-stat-value">${activeRegions}</div>
                        <div class="team-stat-label">Ù…Ù†Ø·Ù‚Ø©</div>
                    </div>
                    ` : ''}
                    <div class="team-stat">
                        <div class="team-stat-value">${activeBranches}</div>
                        <div class="team-stat-label">ÙØ±Ø¹ Ù†Ø´Ø·</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading branches summary:', error);
            container.innerHTML = '<div class="text-muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
        }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>

<style>
    .scope-badge {
        display: inline-block;
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .team-stats {
        display: flex;
        justify-content: space-around;
        padding: 1rem 0;
    }

    .team-stat {
        text-align: center;
    }

    .team-stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--teal-600);
    }

    .team-stat-label {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }
</style>
{% endblock %}
