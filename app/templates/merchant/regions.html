{% extends "merchant/layout.html" %}

{% block title %}Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ - Ø§Ù„ØªØ§Ø¬Ø±{% endblock %}

{% block page_content %}
<div id="regions-content">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>

<!-- Add Region Modal -->
<div id="add-region-modal" class="modal hidden">
    <div class="modal-backdrop" onclick="closeAddModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <button class="modal-close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-region-form" onsubmit="handleAddRegion(event)">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¹Ø±Ø¨ÙŠ) *</label>
                    <input type="text" name="name_ar" class="form-input" required placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØ³Ø·Ù‰">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                    <input type="text" name="name_en" class="form-input" dir="ltr" placeholder="e.g. Central Region">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                    <input type="text" name="city" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙŠØ§Ø¶">
                </div>
                <div class="form-group">
                    <label class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <textarea name="area_description" class="form-input" rows="3" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù†Ø·Ù‚Ø©..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Region Modal -->
<div id="edit-region-modal" class="modal hidden">
    <div class="modal-backdrop" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-region-form" onsubmit="handleEditRegion(event)">
                <input type="hidden" name="region_id" id="edit-region-id">
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¹Ø±Ø¨ÙŠ) *</label>
                    <input type="text" name="name_ar" id="edit-name-ar" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                    <input type="text" name="name_en" id="edit-name-en" class="form-input" dir="ltr">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                    <input type="text" name="city" id="edit-city" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                    <textarea name="area_description" id="edit-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select name="is_active" id="edit-status" class="form-input">
                        <option value="true">Ù†Ø´Ø·Ø©</option>
                        <option value="false">ØºÙŠØ± Ù†Ø´Ø·Ø©</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let allRegions = [];
    let allBranches = [];
    let allStaff = [];

    async function loadRegions() {
        const container = document.getElementById('regions-content');
        const user = TokenManager.getUser();

        // Only owner and executive manager can see this page
        if (!isTopLevel()) {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</p>
                    <a href="/merchant" class="btn btn-primary mt-4">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                </div>
            `;
            return;
        }

        try {
            // Load data
            const [regionsRes, branchesRes, staffRes] = await Promise.all([
                API.merchant.getRegions(),
                API.merchant.getBranches(),
                API.merchant.getStaff()
            ]);

            allRegions = regionsRes.data?.data?.regions || [];
            allBranches = branchesRes.data?.data?.branches || [];
            allStaff = staffRes.data?.data?.staff || [];

            container.innerHTML = `
                <!-- Page Header -->
                <div class="page-header flex justify-between items-center mb-6">
                    <div>
                        <h1 class="page-title">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„ÙØ±ÙˆØ¹</h1>
                        <p class="text-muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <span>â•</span> Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-3 mb-6">
                    <div class="stat-card teal">
                        <div class="stat-card-header">
                            <span>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>
                            <span style="font-size: 2rem;">ğŸ—ºï¸</span>
                        </div>
                        <div class="stat-card-value">${allRegions.filter(r => r.is_active).length}</div>
                        <div class="stat-card-label">Ù…Ù†Ø·Ù‚Ø© Ù†Ø´Ø·Ø©</div>
                    </div>
                    <div class="stat-card emerald">
                        <div class="stat-card-header">
                            <span>Ø§Ù„ÙØ±ÙˆØ¹</span>
                            <span style="font-size: 2rem;">ğŸª</span>
                        </div>
                        <div class="stat-card-value">${allBranches.filter(b => b.is_active).length}</div>
                        <div class="stat-card-label">ÙØ±Ø¹ Ù†Ø´Ø·</div>
                    </div>
                    <div class="stat-card amber">
                        <div class="stat-card-header">
                            <span>Ù…Ø¯Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</span>
                            <span style="font-size: 2rem;">ğŸ‘¤</span>
                        </div>
                        <div class="stat-card-value">${allStaff.filter(s => s.role === 'region_manager').length}</div>
                        <div class="stat-card-label">Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø©</div>
                    </div>
                </div>

                <!-- Regions List -->
                <div id="regions-list">
                    ${renderRegions()}
                </div>
            `;

        } catch (error) {
            console.error('Error loading regions:', error);
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    function renderRegions() {
        if (allRegions.length === 0) {
            return `
                <div class="card text-center p-6">
                    <span style="font-size: 3rem;">ğŸ—ºï¸</span>
                    <p class="mt-4 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    <button class="btn btn-primary mt-4" onclick="openAddModal()">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ù†Ø·Ù‚Ø©</button>
                </div>
            `;
        }

        return allRegions.map(region => {
            const regionBranches = allBranches.filter(b => b.region_id === region.id);
            const regionManager = allStaff.find(s => s.role === 'region_manager' && s.region_id === region.id);
            const totalStaff = allStaff.filter(s => s.region_id === region.id || regionBranches.some(b => b.id === s.branch_id)).length;

            return `
                <div class="region-card card mb-4">
                    <div class="region-header">
                        <div class="region-info">
                            <div class="region-icon">ğŸ—ºï¸</div>
                            <div>
                                <h3 class="region-name">${region.name_ar}</h3>
                                <div class="region-meta">
                                    ${region.city ? `<span class="meta-item">ğŸ“ ${region.city}</span>` : ''}
                                    <span class="meta-item">ğŸª ${regionBranches.length} ÙØ±Ø¹</span>
                                    <span class="meta-item">ğŸ‘¥ ${totalStaff} Ù…ÙˆØ¸Ù</span>
                                </div>
                            </div>
                        </div>
                        <div class="region-actions">
                            <span class="badge ${region.is_active ? 'badge-success' : 'badge-gray'}">
                                ${region.is_active ? 'Ù†Ø´Ø·Ø©' : 'ØºÙŠØ± Ù†Ø´Ø·Ø©'}
                            </span>
                            <button class="btn btn-sm btn-secondary" onclick="editRegion('${region.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        </div>
                    </div>

                    ${regionManager ? `
                    <div class="region-manager">
                        <div class="manager-avatar">${regionManager.full_name?.charAt(0) || '?'}</div>
                        <div class="manager-info">
                            <div class="manager-name">${regionManager.full_name}</div>
                            <div class="manager-role">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
                        </div>
                    </div>
                    ` : `
                    <div class="region-manager no-manager">
                        <span class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹ÙŠÙ†</span>
                        <a href="/merchant/team" class="btn btn-sm btn-primary">ØªØ¹ÙŠÙŠÙ† Ù…Ø¯ÙŠØ±</a>
                    </div>
                    `}

                    ${regionBranches.length > 0 ? `
                    <div class="region-branches">
                        <div class="branches-header">
                            <span class="branches-title">Ø§Ù„ÙØ±ÙˆØ¹</span>
                            <a href="/merchant/branches?region=${region.id}" class="text-primary text-sm">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="branches-grid">
                            ${regionBranches.slice(0, 4).map(branch => {
                                const branchManager = allStaff.find(s => s.role === 'branch_manager' && s.branch_id === branch.id);
                                const cashierCount = allStaff.filter(s => s.role === 'cashier' && s.branch_id === branch.id).length;
                                return `
                                    <div class="branch-item">
                                        <div class="branch-icon">ğŸª</div>
                                        <div class="branch-info">
                                            <div class="branch-name">${branch.name_ar}</div>
                                            <div class="branch-meta">
                                                ${branchManager ? branchManager.full_name : 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠØ±'}
                                                â€¢ ${cashierCount} ÙƒØ§Ø´ÙŠØ±
                                            </div>
                                        </div>
                                        <span class="badge ${branch.is_active ? 'badge-success' : 'badge-gray'} text-xs">
                                            ${branch.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                            ${regionBranches.length > 4 ? `
                                <div class="branch-item more-branches">
                                    <span>+${regionBranches.length - 4} ÙØ±ÙˆØ¹ Ø£Ø®Ø±Ù‰</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : `
                    <div class="region-branches empty">
                        <span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
                        <a href="/merchant/branches" class="btn btn-sm btn-primary">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</a>
                    </div>
                    `}
                </div>
            `;
        }).join('');
    }

    function openAddModal() {
        document.getElementById('add-region-modal').classList.remove('hidden');
    }

    function closeAddModal() {
        document.getElementById('add-region-modal').classList.add('hidden');
        document.getElementById('add-region-form').reset();
    }

    async function handleAddRegion(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const data = {
            name_ar: formData.get('name_ar'),
            name_en: formData.get('name_en'),
            city: formData.get('city'),
            area_description: formData.get('area_description'),
        };

        try {
            const res = await API.merchant.createRegion(data);
            if (res.success) {
                closeAddModal();
                loadRegions();
                alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert(res.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            console.error('Error adding region:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
        }
    }

    function editRegion(regionId) {
        const region = allRegions.find(r => r.id === regionId);
        if (!region) return;

        document.getElementById('edit-region-id').value = region.id;
        document.getElementById('edit-name-ar').value = region.name_ar || '';
        document.getElementById('edit-name-en').value = region.name_en || '';
        document.getElementById('edit-city').value = region.city || '';
        document.getElementById('edit-description').value = region.area_description || '';
        document.getElementById('edit-status').value = region.is_active ? 'true' : 'false';

        document.getElementById('edit-region-modal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('edit-region-modal').classList.add('hidden');
    }

    async function handleEditRegion(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const regionId = formData.get('region_id');

        const data = {
            name_ar: formData.get('name_ar'),
            name_en: formData.get('name_en'),
            city: formData.get('city'),
            area_description: formData.get('area_description'),
            is_active: formData.get('is_active') === 'true',
        };

        try {
            const res = await API.merchant.updateRegion(regionId, data);
            if (res.success) {
                closeEditModal();
                loadRegions();
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert(res.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            console.error('Error updating region:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
        }
    }

    document.addEventListener('DOMContentLoaded', loadRegions);
</script>

<style>
    .page-title {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .region-card {
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
    }

    .region-card:hover {
        border-color: var(--teal-300);
        box-shadow: var(--shadow-lg);
    }

    .region-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
        margin-bottom: 1rem;
    }

    .region-info {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }

    .region-icon {
        font-size: 2rem;
        background: var(--teal-50);
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
    }

    .region-name {
        font-size: 1.25rem;
        margin: 0 0 0.5rem 0;
    }

    .region-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .meta-item {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .region-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .region-manager {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        margin-bottom: 1rem;
    }

    .region-manager.no-manager {
        justify-content: space-between;
    }

    .manager-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--teal-400), var(--teal-500));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
    }

    .manager-name {
        font-weight: 600;
    }

    .manager-role {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    .region-branches {
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
    }

    .region-branches.empty {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .branches-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .branches-title {
        font-weight: 600;
        color: var(--gray-700);
    }

    .branches-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    @media (max-width: 768px) {
        .branches-grid {
            grid-template-columns: 1fr;
        }
    }

    .branch-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
    }

    .branch-item.more-branches {
        justify-content: center;
        color: var(--gray-500);
        font-size: 0.875rem;
    }

    .branch-icon {
        font-size: 1.25rem;
    }

    .branch-info {
        flex: 1;
    }

    .branch-name {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .branch-meta {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal.hidden {
        display: none !important;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background: white;
        border-radius: var(--radius-2xl);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h3 {
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-500);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .text-xs {
        font-size: 0.65rem;
    }
</style>
{% endblock %}
